<odoo>

    <record id="auto_update_aal_from_sp" model="base.automation">
        <field name="name">=> Auto AAL from SP on stock.valuation.layer </field>
        <field name="model_id" ref="model_stock_valuation_layer"/>
        <field name="state">code</field>
        <field name="code">
move = record.stock_move_id
picking = move.picking_id
analytic = move.analytic_account_id
plan = analytic.plan_id
status = picking.state
code = picking.picking_type_id.code

exist = record.analytic_id
name = record.description
quantity = record.quantity
uom = record.uom_id
unitprice = record.unit_cost
value = record.value

if (move.id and picking.id and analytic.id and not exist.id and status == 'done') and (code in ['incoming','outgoing']):
  new = env['account.analytic.line'].create({'name':name, 'account_id':analytic.id, 'product_id':record.product_id.id, 'plan_id':plan.id,
    'product_uom_id':uom.id, 'unit_amount':quantity, 'amount':value
  })
  record['analytic_id'] = new.id

elif (move.id and picking.id and analytic.id and exist.id and status == 'done') and (code in ['incoming','outgoing']):
  exist.write({'name':name, 'account_id':analytic.id, 'product_id':record.product_id.id, 'plan_id':plan.id,
    'product_uom_id':uom.id, 'unit_amount':quantity, 'amount':value
  })
        </field>
        <field name="trigger">on_create_or_write</field>
        <field name="filter_pre_domain"></field>
        <field name="filter_domain"></field>
        <field name="active" eval="True"/>
    </record>



</odoo>